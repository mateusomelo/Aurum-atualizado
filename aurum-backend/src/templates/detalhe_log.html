{% extends "base.html" %}

{% block title %}Detalhes do Log #{{ log.id }}{% endblock %}

{% block extra_css %}
<style>
    .detail-card {
        background: #f8f9fa;
        border-left: 4px solid #007bff;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .detail-row {
        margin-bottom: 15px;
    }
    
    .detail-label {
        font-weight: bold;
        color: #495057;
        min-width: 150px;
        display: inline-block;
    }
    
    .detail-value {
        color: #212529;
    }
    
    .json-viewer {
        background: #2d3748;
        color: #e2e8f0;
        padding: 15px;
        border-radius: 5px;
        font-family: 'Courier New', monospace;
        font-size: 0.9em;
        overflow-x: auto;
        max-height: 300px;
        overflow-y: auto;
    }
    
    .action-badge {
        font-size: 1em;
        font-weight: bold;
        padding: 8px 12px;
    }
    
    .action-CREATE { background: #28a745; }
    .action-UPDATE { background: #ffc107; color: #000; }
    .action-DELETE { background: #dc3545; }
    .action-LOGIN_SUCCESS { background: #17a2b8; }
    .action-LOGIN_FAILED { background: #fd7e14; }
    .action-LOGOUT { background: #6c757d; }
    .action-VIEW { background: #6f42c1; }
    .action-ERROR { background: #dc3545; }
    .action-EXPORT { background: #20c997; }
    
    .module-badge {
        background: #e9ecef;
        color: #495057;
        padding: 6px 12px;
        border-radius: 15px;
        font-size: 0.9em;
    }
    
    .user-card {
        background: linear-gradient(45deg, #007bff, #0056b3);
        color: white;
        border-radius: 10px;
        padding: 20px;
        text-align: center;
    }
    
    .user-card h5 {
        margin: 0;
        font-size: 1.3em;
    }
    
    .user-card p {
        margin: 5px 0;
        opacity: 0.9;
    }
    
    .timeline-item {
        border-left: 3px solid #007bff;
        padding-left: 20px;
        margin-bottom: 20px;
        position: relative;
    }
    
    .timeline-item::before {
        content: '';
        position: absolute;
        left: -6px;
        top: 5px;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: #007bff;
    }
    
    .empty-data {
        color: #6c757d;
        font-style: italic;
        padding: 10px;
        text-align: center;
        border: 2px dashed #dee2e6;
        border-radius: 5px;
    }
    
    @media (max-width: 768px) {
        .detail-label {
            display: block;
            min-width: auto;
            margin-bottom: 5px;
        }
        
        .json-viewer {
            font-size: 0.8em;
        }
        
        .user-card {
            margin-bottom: 20px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2><i class="fas fa-file-alt"></i> Detalhes do Log #{{ log.id }}</h2>
        <div>
            <a href="{{ url_for('activity_logs.listar_logs') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Voltar
            </a>
        </div>
    </div>

    <div class="row">
        <!-- Informações Básicas -->
        <div class="col-md-8">
            <div class="detail-card">
                <h4 class="mb-3"><i class="fas fa-info-circle"></i> Informações Básicas</h4>
                
                <div class="detail-row">
                    <span class="detail-label">Data/Hora:</span>
                    <span class="detail-value">
                        <i class="fas fa-clock"></i>
                        {{ log.timestamp.strftime('%d/%m/%Y às %H:%M:%S') if log.timestamp else 'Não informado' }}
                    </span>
                </div>
                
                <div class="detail-row">
                    <span class="detail-label">Ação:</span>
                    <span class="badge action-badge action-{{ log.action }}">
                        {{ log.action }}
                    </span>
                </div>
                
                <div class="detail-row">
                    <span class="detail-label">Módulo:</span>
                    <span class="module-badge">{{ log.module }}</span>
                </div>
                
                <div class="detail-row">
                    <span class="detail-label">Descrição:</span>
                    <div class="detail-value mt-2">
                        <div class="alert alert-info">
                            <i class="fas fa-comment"></i>
                            {{ log.description }}
                        </div>
                    </div>
                </div>
                
                {% if log.entity_type or log.entity_id %}
                <div class="detail-row">
                    <span class="detail-label">Entidade Afetada:</span>
                    <span class="detail-value">
                        <i class="fas fa-tag"></i>
                        {{ log.entity_type or 'N/A' }} 
                        {% if log.entity_id %}
                            <strong>#{{ log.entity_id }}</strong>
                        {% endif %}
                    </span>
                </div>
                {% endif %}
            </div>

            <!-- Informações Técnicas -->
            <div class="detail-card">
                <h4 class="mb-3"><i class="fas fa-server"></i> Informações Técnicas</h4>
                
                <div class="detail-row">
                    <span class="detail-label">Endereço IP:</span>
                    <span class="detail-value">
                        <i class="fas fa-globe"></i>
                        {{ log.ip_address or 'Não identificado' }}
                    </span>
                </div>
                
                <div class="detail-row">
                    <span class="detail-label">Endpoint:</span>
                    <span class="detail-value">
                        <code>{{ log.endpoint or 'N/A' }}</code>
                    </span>
                </div>
                
                <div class="detail-row">
                    <span class="detail-label">Método HTTP:</span>
                    <span class="detail-value">
                        {% if log.method %}
                            <span class="badge bg-info">{{ log.method }}</span>
                        {% else %}
                            N/A
                        {% endif %}
                    </span>
                </div>
                
                <div class="detail-row">
                    <span class="detail-label">Status HTTP:</span>
                    <span class="detail-value">
                        {% if log.status_code %}
                            <span class="badge {% if log.status_code < 400 %}bg-success{% else %}bg-danger{% endif %}">
                                {{ log.status_code }}
                            </span>
                        {% else %}
                            N/A
                        {% endif %}
                    </span>
                </div>
                
                <div class="detail-row">
                    <span class="detail-label">Tempo de Resposta:</span>
                    <span class="detail-value">
                        {% if log.response_time %}
                            <i class="fas fa-stopwatch"></i>
                            {{ log.response_time|round(2) }} ms
                        {% else %}
                            N/A
                        {% endif %}
                    </span>
                </div>
                
                {% if log.user_agent %}
                <div class="detail-row">
                    <span class="detail-label">User Agent:</span>
                    <div class="detail-value mt-1">
                        <small class="text-muted">{{ log.user_agent }}</small>
                    </div>
                </div>
                {% endif %}
                
                {% if log.session_id %}
                <div class="detail-row">
                    <span class="detail-label">ID da Sessão:</span>
                    <span class="detail-value">
                        <code>{{ log.session_id }}</code>
                    </span>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Informações do Usuário -->
        <div class="col-md-4">
            <div class="user-card mb-3">
                <i class="fas fa-user fa-2x mb-2"></i>
                <h5>{{ log.user_name or 'Sistema' }}</h5>
                {% if log.user_type %}
                    <p><i class="fas fa-id-badge"></i> {{ log.user_type.title() }}</p>
                {% endif %}
                {% if log.user_email %}
                    <p><i class="fas fa-envelope"></i> {{ log.user_email }}</p>
                {% endif %}
                {% if log.user_id %}
                    <p><i class="fas fa-hashtag"></i> ID: {{ log.user_id }}</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Dados Alterados -->
    <div class="row">
        {% if log.get_old_values() or log.get_new_values() %}
        <div class="col-md-6">
            <div class="detail-card">
                <h4 class="mb-3"><i class="fas fa-history"></i> Valores Antigos</h4>
                {% set old_values = log.get_old_values() %}
                {% if old_values %}
                    <div class="json-viewer">{{ old_values | tojson(indent=2) }}</div>
                {% else %}
                    <div class="empty-data">Nenhum valor anterior registrado</div>
                {% endif %}
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="detail-card">
                <h4 class="mb-3"><i class="fas fa-edit"></i> Valores Novos</h4>
                {% set new_values = log.get_new_values() %}
                {% if new_values %}
                    <div class="json-viewer">{{ new_values | tojson(indent=2) }}</div>
                {% else %}
                    <div class="empty-data">Nenhum valor novo registrado</div>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Dados Extras -->
    {% if log.get_extra_data() %}
    <div class="row">
        <div class="col-12">
            <div class="detail-card">
                <h4 class="mb-3"><i class="fas fa-database"></i> Dados Adicionais</h4>
                <div class="json-viewer">{{ log.get_extra_data() | tojson(indent=2) }}</div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Timeline de Ações Relacionadas -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="detail-card">
                <h4 class="mb-3"><i class="fas fa-timeline"></i> Ações Relacionadas</h4>
                <p class="text-muted mb-3">
                    Outras ações realizadas pelo mesmo usuário nos últimos 30 minutos
                </p>
                
                <div id="related-actions">
                    <div class="text-center py-3">
                        <i class="fas fa-spinner fa-spin"></i>
                        Carregando ações relacionadas...
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Carregar ações relacionadas
document.addEventListener('DOMContentLoaded', function() {
    const logId = {{ log.id }};
    const userId = {{ log.user_id or 'null' }};
    const timestamp = '{{ log.timestamp.isoformat() if log.timestamp else "" }}';
    
    if (userId && timestamp) {
        // Buscar logs do mesmo usuário em um período próximo
        fetch(`{{ url_for('activity_logs.logs_api') }}?user_id=${userId}&limit=10`)
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('related-actions');
                const relatedLogs = data.logs.filter(l => l.id !== logId);
                
                if (relatedLogs.length === 0) {
                    container.innerHTML = '<div class="empty-data">Nenhuma ação relacionada encontrada</div>';
                    return;
                }
                
                let html = '';
                relatedLogs.forEach(relatedLog => {
                    const logTime = new Date(relatedLog.timestamp).toLocaleString('pt-BR');
                    html += `
                        <div class="timeline-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <strong class="badge action-${relatedLog.action}">${relatedLog.action}</strong>
                                    <span class="module-badge ms-2">${relatedLog.module}</span>
                                    <p class="mt-1 mb-1">${relatedLog.description}</p>
                                    <small class="text-muted">
                                        <i class="fas fa-clock"></i> ${logTime}
                                    </small>
                                </div>
                                <a href="{{ url_for('activity_logs.detalhe_log', log_id=0) }}".replace('0', relatedLog.id) 
                                   class="btn btn-sm btn-outline-info">
                                    <i class="fas fa-eye"></i>
                                </a>
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            })
            .catch(error => {
                console.error('Erro ao carregar ações relacionadas:', error);
                document.getElementById('related-actions').innerHTML = 
                    '<div class="empty-data">Erro ao carregar ações relacionadas</div>';
            });
    } else {
        document.getElementById('related-actions').innerHTML = 
            '<div class="empty-data">Não há informações suficientes para buscar ações relacionadas</div>';
    }
});
</script>
{% endblock %}