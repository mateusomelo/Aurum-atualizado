{% extends "base.html" %}

{% block title %}Teste de Notifica√ß√µes{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h2>üîî Teste de Notifica√ß√µes</h2>
            <p>Use esta p√°gina para testar o sistema de notifica√ß√µes.</p>
        </div>
    </div>
    
    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>Informa√ß√µes do Sistema</h5>
                </div>
                <div class="card-body">
                    <p><strong>Tipo de Usu√°rio:</strong> <span id="user-type">{{ session.user_type }}</span></p>
                    <p><strong>Nome:</strong> {{ session.user_name }}</p>
                    <p><strong>Sistema Ativo:</strong> <span id="system-status">Verificando...</span></p>
                    <p><strong>Permiss√µes:</strong> <span id="permissions-status">Verificando...</span></p>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>Testes Manuais</h5>
                </div>
                <div class="card-body">
                    <button class="btn btn-primary mb-2" onclick="testNotification()">
                        üß™ Testar Notifica√ß√£o
                    </button><br>
                    
                    <button class="btn btn-info mb-2" onclick="checkAPI()">
                        üîç Verificar API
                    </button><br>
                    
                    <button class="btn btn-warning mb-2" onclick="requestPermissions()">
                        üîê Solicitar Permiss√µes
                    </button><br>
                    
                    <button class="btn btn-success mb-2" onclick="createTestTicket()">
                        üé´ Criar Chamado de Teste
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5>Console de Debug</h5>
                </div>
                <div class="card-body">
                    <div id="debug-console" style="background: #f8f9fa; padding: 10px; border-radius: 5px; height: 300px; overflow-y: scroll; font-family: monospace; font-size: 12px;">
                        <div>üöÄ Sistema iniciado...</div>
                    </div>
                    <button class="btn btn-secondary mt-2" onclick="clearConsole()">Limpar Console</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Fun√ß√µes de teste
function log(message) {
    const console = document.getElementById('debug-console');
    const time = new Date().toLocaleTimeString();
    console.innerHTML += `<div>[${time}] ${message}</div>`;
    console.scrollTop = console.scrollHeight;
}

function clearConsole() {
    document.getElementById('debug-console').innerHTML = '<div>üöÄ Console limpo...</div>';
}

async function testNotification() {
    log('üß™ Testando notifica√ß√£o...');
    
    if (window.simpleNotifications) {
        window.simpleNotifications.test();
        log('‚úÖ Teste executado via simpleNotifications');
    } else if (window.testNotifications) {
        window.testNotifications();
        log('‚úÖ Teste executado via testNotifications');
    } else {
        log('‚ùå Sistema de notifica√ß√µes n√£o encontrado');
        alert('Sistema de notifica√ß√µes n√£o carregado!');
    }
}

async function checkAPI() {
    log('üîç Verificando API...');
    
    try {
        const response = await fetch('/api/notificacoes/nao_lidas');
        const data = await response.json();
        
        log(`‚úÖ API responde: ${JSON.stringify(data)}`);
        
        document.getElementById('system-status').textContent = 
            response.ok ? '‚úÖ Funcionando' : '‚ùå Com problemas';
            
    } catch (error) {
        log(`‚ùå Erro na API: ${error.message}`);
        document.getElementById('system-status').textContent = '‚ùå Erro';
    }
}

async function requestPermissions() {
    log('üîê Solicitando permiss√µes...');
    
    if ('Notification' in window) {
        try {
            const permission = await Notification.requestPermission();
            log(`‚úÖ Permiss√£o: ${permission}`);
            
            document.getElementById('permissions-status').textContent = 
                permission === 'granted' ? '‚úÖ Concedidas' : '‚ùå Negadas';
                
        } catch (error) {
            log(`‚ùå Erro ao solicitar permiss√µes: ${error.message}`);
        }
    } else {
        log('‚ùå Navegador n√£o suporta notifica√ß√µes');
        document.getElementById('permissions-status').textContent = '‚ùå N√£o suportadas';
    }
}

async function createTestTicket() {
    log('üé´ Criando chamado de teste...');
    
    try {
        // Redirecionar para p√°gina de criar chamado
        window.location.href = '/criar_chamado';
        
    } catch (error) {
        log(`‚ùå Erro: ${error.message}`);
    }
}

// Verifica√ß√µes iniciais
document.addEventListener('DOMContentLoaded', function() {
    log('üìù P√°gina carregada, verificando sistema...');
    
    // Verificar tipo de usu√°rio
    const userType = document.body.getAttribute('data-user-type');
    log(`üë§ Tipo de usu√°rio: ${userType}`);
    
    // Verificar se sistema est√° carregado
    setTimeout(() => {
        if (window.simpleNotifications) {
            log('‚úÖ simpleNotifications carregado');
            document.getElementById('system-status').textContent = '‚úÖ Ativo';
        } else {
            log('‚ùå simpleNotifications n√£o encontrado');
            document.getElementById('system-status').textContent = '‚ùå Inativo';
        }
        
        // Verificar permiss√µes
        if ('Notification' in window) {
            const permission = Notification.permission;
            log(`üîê Permiss√µes atuais: ${permission}`);
            document.getElementById('permissions-status').textContent = 
                permission === 'granted' ? '‚úÖ Concedidas' : 
                permission === 'denied' ? '‚ùå Negadas' : '‚ö†Ô∏è N√£o solicitadas';
        }
    }, 2000);
    
    // Verificar API automaticamente
    setTimeout(checkAPI, 3000);
});
</script>
{% endblock %}